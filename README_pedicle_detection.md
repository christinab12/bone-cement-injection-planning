# Pedicle detection

## What is this?

Pedicle detection is an additional part of BICEPS. It aims to increase accuracy by only considering vertebral bodies in the evaulations (in other words, it neglects the spinal processes as the current inpainting pipeline has sometimes problems reproducing them correctly).

Vertebral bodies are separated from the spinal processes after the final inpainting step. For the comparison of volumes, the separation is also performed for the pre-fractured (healthy) and post-operative scan.

## How does this work?

To enable pedicle detection, an additional parameter named --pedicle_detection has to be provided. An exemplary run could be executed with the following command:

```
python main.py --patient_dir ./patient01/ --fracture 20 --healthy --post_op --pedicle_detection
```

For pedicle detection to work properly, some additional input files have to be provided. The following tree summarized the required filed:

```
--patient01
  --02052016
    --ct_scan.nii
    --ct_scan_seg-subreg_ctd.json
  --04122019
    --ct_scan.nii
    --ct_scan_seg-subreg_ctd.json
  --20122019
    --ct_scan.nii
  --patient01_inpaint_seg-subreg_ctd.json
```

In addition to the required files for standard BICEPS, pedicle detection requires JSON-files that contain the positions of vertebral centroids that correspond to a specific scan.
For the pre-fractured and fractured scans, there has to be a JSON-file that exactly follows the naming shown in the example (<name_of_scan>_seg-subreg_ctd.json).
For the inpainted scan, there also has to be a JSON-file in the main folder that follows the naming shown in the example (<name_of_folder>_inpaint_seg-subreg_ctd.json).

The JSON-files have to follow the syntax demonstrated in this example:

```
{"vertebralCentroids":
    [
        {"direction":["P","I","L"]},
        {"label":18,"X":134.6,"Y":36.7,"Z":23},
        {"label":19,"X":122.4,"Y":97.9,"Z":23},
        {"label":20,"X":114.2,"Y":163.2,"Z":23},
        {"label":21,"X":97.9,"Y":228.5,"Z":23},
        {"label":22,"X":85.7,"Y":301.9,"Z":22}
    ]
}
```
Currently, these JSON-files have to be provided by hand and can be generated with the website [Anduin BoneScreen](https://anduin.bonescreen.de). The JSON-file corresponding to the inpainted image can be generated by first running BICEPS without pedicle detection and saving the temporary files. This will generate a file for the inpainted image that can be used as an input for Anduin BoneScreen. 